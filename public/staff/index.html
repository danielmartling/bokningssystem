<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset="utf-8">
    <link rel="icon" type="image/x-icon" href="/icons/Scoutsymbolen_rgb.png">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bokningssystem - Home</title>

    <link rel="stylesheet" href="/css/main.css">

    <script type="text/javascript" src="https://code.jquery.com/jquery-1.7.1.min.js"></script>
    <script src="//code.iconify.design/1/1.0.6/iconify.min.js"></script>

    <script type="module" src="/js/api/index.js"></script>
    <script src="/js/dateHelpers.js"></script>

    <script src="/js/scripts.js"></script>
    <!-- <script src="../js/groups.js"></script> -->
</head>

<style>
    div.message-header>p.subtitle {
        color: black !important;
    }
</style>

<body class="has-navbar-fixed-top">
    <nav id="common-staff-navbar" class="navbar is-fixed-top is-primary-staff" role="navigation"
        aria-label="main navigation">
    </nav>

    <div class="container">

        <div class="section" style="--bulma-section-padding: 3rem 0rem;">
            <div class="content">
                <div class="container" id="notification-container"></div>

                <h1 class="title">Program - Home</h1>

                <div id="programDayMessage"></div>
            </div>

            <div class="columns">
                <div class="column is-two-thirds">
                    <div class="box">
                        <div class="content">
                            <p class="subtitle is-3">Bookings today <button class="button" id="allToggle">All?</button>
                            </p>
                            <div class="table-container">
                                <table
                                    class="table is-fullwidth is-hoverable is-bordered is-striped has-sticky-header has-sticky-column">
                                    <thead id="activitiesTable"></thead>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="column is-one-third">
                    <div class="box">
                        <div class="content">
                            <p class="subtitle is-3">On island today</p>
                            <ul id="groupsTodayList"></ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer" id="common-footer"></footer>

</body>

<script>

    const today = todayString();

    document.addEventListener('DOMContentLoaded', () => {
        initHTML();
        init();
    });

    async function init() {
        await renderDayMessage();
        await renderGroupsToday(today);
    }

    async function renderDayMessage() {
        const programDayMessage = document.getElementById("programDayMessage");
        const programDay = await api.getProgramDay(today);
        const message = document.createElement("article");
        message.classList.add("message", "is-primary-staff");
        if (programDay) {
            message.innerHTML = `
                <div class="message-header">
                    <p class="subtitle is-3" style="margin: 0px;">${today}${(!programDay.title || programDay.title === "") ? "" : ":&nbsp;" + programDay.title}</p>
                    <button class="button" id="edit-btn"><span class="iconify" data-icon="mdi-${programDay.title || programDay.message ? "edit" : "add"}"></span></button>
                </div>
                <div class="message-body" style="white-space: pre-wrap;">${(!programDay.message || programDay.message === "") ? "<i>No daily message... Add one with the button above.</i>" : programDay.message}</div>
            `;
        } else {
            message.innerHTML = `
                <div class="message-header">
                    <p class="subtitle is-3" style="margin: 0px;">${today}</p>
                    <button class="button" id="edit-btn"><span class="iconify" data-icon="mdi-edit"></span></button>
                </div>
                <div class="message-body"></div>
            `;
        };
        programDayMessage.appendChild(message);

        const editBtn = document.getElementById("edit-btn");
        if (editBtn) editBtn.addEventListener("click", () => enterEditMode(message, programDay));
    }

    function enterEditMode(messageElement, programDay) {
        const header = messageElement.querySelector(".message-header");
        const body = messageElement.querySelector(".message-body");

        header.innerHTML = `
            <span style="min-width: 120px;">${today}:&nbsp;</span><input class="input" id="edit-title" value="${programDay ? programDay.title : ""}" placeholder="Program day title" />
        `;

        body.innerHTML = `
            <textarea class="textarea" id="edit-message" placeholder="Program day message">${programDay ? programDay.message : ""}</textarea>

            <div class="buttons" style="margin-top: 16px;">
                <button class="button is-success" id="save-btn">Save</button>
                <button class="button is-danger" id="cancel-btn">Cancel</button>
            </div>
        `;

        document.getElementById("save-btn").addEventListener("click", async () => {
            await api.saveProgramDay(today, document.getElementById("edit-title").value, document.getElementById("edit-message").value)
            messageElement.remove();
            renderDayMessage();
        });

        document.getElementById("cancel-btn").addEventListener("click", () => {
            messageElement.remove();
            renderDayMessage();
        });
    }

    async function renderGroupsToday(day) {
        groupsTodayList = document.getElementById("groupsTodayList");
        const groupsToday = await api.getGroupsByDay(day);
        let groupsArrivingHtml = "";
        let groupsStayingHtml = "";
        let groupsDepartingHtml = "";

        if (groupsToday.length == 0) {
            return `<i>No groups today...</i>`;
        } else {
            groupsToday
                .sort((a, b) => a.name.localeCompare(b.name, "sv"))
                .forEach(group => {
                    if (group.arrival_date === day) {
                        groupsArrivingHtml += `<li><a href="/staff/groups/view.html?booking_number=${group.booking_number}">${group.name}</a></li>`;
                    } else if (group.departure_date === day) {
                        groupsDepartingHtml += `<li><a href="/staff/groups/view.html?booking_number=${group.booking_number}">${group.name}</a></li>`;
                    } else {
                        groupsStayingHtml += `<li><a href="/staff/groups/view.html?booking_number=${group.booking_number}">${group.name}</a></li>`;
                    }
                });
            const groupsTodayHtml = `
            ${groupsArrivingHtml == "" ? "" : "<p class='subtitle is-5'>Arriving</p><ul>" + groupsArrivingHtml + "</ul>"}
            ${groupsStayingHtml == "" ? "" : "<p class='subtitle is-5'>Staying</p><ul>" + groupsStayingHtml + "</ul>"}
            ${groupsDepartingHtml == "" ? "" : "<p class='subtitle is-5'>Leaving</p><ul>" + groupsDepartingHtml + "</ul>"}`;
            groupsTodayList.innerHTML = groupsTodayHtml;
        }
    }

    // function renderShift(shift) {
    //     switch (shift) { case 0: return "FM"; break; case 1: return "EM"; break; case 2: return "KV"; break; case 3: return "Natt"; break; };
    // }


    // function doStuff() {
    //     document.getElementById("allToggle").addEventListener("click", () => {
    //         document.getElementById("activitiesTable").innerHTML = "";
    //         all = !all;
    //         init();
    //     })

    //     // bookingsToday = all ? await api.getTodaysBookings() : await api.getTodaysBookingsProgram();
    //     bookingsToday = [];
    //     activitiesTable = document.getElementById("activitiesTable");

    //     // console.log(bookingsToday);

    //     if (bookingsToday.length === 0) {
    //         activitiesTable.innerHTML = `
    //             <tr>
    //                 <th colspan = "3"><i>No bookings today...</i></th>
    //             </tr>
    //         `;
    //     } else {
    //         bookingsToday.forEach(booking => {
    //             activitiesTable.innerHTML += `
    //             <tr>
    //                 <th>${booking.activity_name}</th>
    //                 <th>${booking.group_name}</th>
    //                 <td>${renderShift(booking.shift)}</td>
    //             </tr>
    //         `;
    //         })
    //     }
    // }



</script>

</html>